{% extends "_base_dashboard.html" %}
{% load static %}

{% block title %}User Management & Monitoring - Gagasan{% endblock %}

{% block dashboard_content %}
<div class="p-8">
  <div class="flex items-center gap-4 mb-6">
    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
      <i class="fas fa-users-cog text-purple-600 text-xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-gray-900">User Management & Monitoring</h1>
      <p class="text-sm text-gray-600">Review, setujui, dan kelola akun pengguna.</p>
    </div>
  </div>

  {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="p-4 rounded-md text-sm
            {% if message.tags == 'success' %} bg-green-50 border border-green-200 text-green-800
            {% elif message.tags == 'warning' %} bg-yellow-50 border border-yellow-200 text-yellow-800
            {% elif message.tags == 'error' %} bg-red-50 border border-red-200 text-red-800
            {% else %} bg-blue-50 border border-blue-200 text-blue-800 {% endif %} flex items-start gap-2">
             {% if message.tags == 'success' %}<i class="fas fa-check-circle mt-0.5"></i>
             {% elif message.tags == 'warning' %}<i class="fas fa-exclamation-triangle mt-0.5"></i>
             {% elif message.tags == 'error' %}<i class="fas fa-times-circle mt-0.5"></i>
             {% else %}<i class="fas fa-info-circle mt-0.5"></i>{% endif %}
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
      <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center shrink-0">
        <i class="fas fa-users text-blue-600"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-500">Total Users</p>
        <p class="text-3xl font-bold text-gray-900">{{ total_users_count }}</p>
        <p class="text-xs text-gray-400">Pengguna terdaftar</p>
      </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
      <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center shrink-0">
        <i class="fas fa-user-check text-green-600"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-500">Active Users</p>
        <p class="text-3xl font-bold text-green-600">{{ active_users_count }}</p>
        <p class="text-xs text-gray-400">Pengguna aktif</p>
      </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
      <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center shrink-0">
        <i class="fas fa-clock text-yellow-600"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-500">Pending Approval</p>
        <p class="text-3xl font-bold text-yellow-600">{{ pending_approval_count }}</p>
        <p class="text-xs text-gray-400">Menunggu approval</p>
      </div>
    </div>
  </div>

  <div class="mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-3">Distribusi Pengguna</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center shrink-0">
                <i class="fas fa-user-graduate text-blue-600"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Mahasiswa</p>
                <p class="text-2xl font-bold text-gray-900">{{ mahasiswa_count }}</p>
                <p class="text-xs text-gray-400">Total mahasiswa terdaftar</p>
            </div>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center shrink-0">
                <i class="fas fa-user-tie text-green-600"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Dosen</p>
                <p class="text-2xl font-bold text-gray-900">{{ dosen_count }}</p>
                <p class="text-xs text-gray-400">Dosen pembimbing</p>
            </div>
        </div>
        <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4">
            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center shrink-0">
                <i class="fas fa-building text-purple-600"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Mitra</p>
                <p class="text-2xl font-bold text-gray-900">{{ mitra_count }}</p>
                <p class="text-xs text-gray-400">Mitra industri</p>
            </div>
        </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
            <a href="?tab=pending" class="{% if current_tab == 'pending' %}border-purple-500 text-purple-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                <i class="fas fa-clock"></i>
                Account Requests
                <span class="{% if current_tab == 'pending' %} bg-purple-100 text-purple-600 {% else %} bg-gray-100 text-gray-600 {% endif %} ml-1 py-0.5 px-2.5 rounded-full text-xs font-medium">{{ pending_approval_count }}</span>
            </a>
            <a href="?tab=all" class="{% if current_tab == 'all' %}border-purple-500 text-purple-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                <i class="fas fa-users"></i>
                All Users
                <span class="{% if current_tab == 'all' %} bg-purple-100 text-purple-600 {% else %} bg-gray-100 text-gray-600 {% endif %} ml-1 py-0.5 px-2.5 rounded-full text-xs font-medium">{{ total_users_count }}</span>
            </a>
        </nav>
    </div>

    <div>
        {% if current_tab == 'pending' %}
        <div id="pending-requests" class="p-0 sm:p-6">
            <div class="px-6 pt-6 hidden sm:block">
              <h3 class="text-lg font-semibold text-gray-800 mb-1">Pending Account Requests</h3>
              <p class="text-sm text-gray-500 mb-4">Review dan setujui (approve) atau tolak (reject) permintaan akun baru.</p>
            </div>
            
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Daftar</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  
                  {% for user_obj in users_pending_list %}
                  <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user_obj.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.get_peran_display }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.date_joined|date:"d M Y, H:i" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-1">
                      <form action="{% url 'approve_user' user_obj.id %}" method="POST" class="inline-block" onsubmit="return confirm('Anda yakin ingin menyetujui dan mengaktifkan akun {{ user_obj.username }}?')">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-1.5 bg-green-500 text-white text-xs font-medium rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" title="Setujui Akun">
                          <i class="fas fa-user-check"></i> <span class="hidden sm:inline">Setujui</span>
                        </button>
                      </form>
                      </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-sm text-gray-500">
                      <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-check-circle text-gray-400 text-3xl mb-3"></i>
                        <span class="font-semibold">Tidak Ada Permintaan Akun</span>
                        <p class="mt-1">Semua akun baru sudah disetujui.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}

                </tbody>
              </table>
            </div>
        </div>
        
        {% elif current_tab == 'all' %}
        <div id="all-users" class="p-0 sm:p-6">
            <div class="px-6 pt-6 hidden sm:block">
              <h3 class="text-lg font-semibold text-gray-800 mb-1">Semua Pengguna</h3>
              <p class="text-sm text-gray-500 mb-4">Kelola status aktif atau nonaktif untuk semua pengguna yang telah disetujui.</p>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>
                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Daftar</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  
                  {% for user_obj in all_users_list %}
                  <tr class="{% if not user_obj.is_approved %} bg-yellow-50 hover:bg-yellow-100 {% elif user_obj.status == 'nonaktif' %} bg-red-50 hover:bg-red-100 {% else %} hover:bg-gray-50 {% endif %} transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user_obj.username }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.get_peran_display }}</td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        {% if not user_obj.is_approved %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                        {% elif user_obj.status == 'aktif' %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Aktif</span>
                        {% elif user_obj.status == 'nonaktif' %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Nonaktif</span>
                        {% endif %}
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.date_joined|date:"d M Y, H:i" }}</td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-1">
                      {% if user_obj.is_approved %}
                        <form action="{% url 'toggle_active_user' user_obj.id %}" method="POST" class="inline-block" onsubmit="return confirm('Anda yakin ingin mengubah status akun {{ user_obj.username }}?')">
                           {% csrf_token %}
                           {% if user_obj.status == 'aktif' %}
                             <button type="submit" class="px-3 py-1.5 bg-red-500 text-white text-xs font-medium rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" title="Nonaktifkan Akun">
                               <i class="fas fa-user-times"></i> <span class="hidden sm:inline">Nonaktifkan</span>
                             </button>
                           {% elif user_obj.status == 'nonaktif' %}
                               <button type="submit" class="px-3 py-1.5 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" title="Aktifkan Akun">
                                 <i class="fas fa-user-plus"></i> <span class="hidden sm:inline">Aktifkan</span>
                               </button>
                           {% endif %}
                        </form>
                      {% else %}
                        <form action="{% url 'approve_user' user_obj.id %}" method="POST" class="inline-block" onsubmit="return confirm('Anda yakin ingin menyetujui dan mengaktifkan akun {{ user_obj.username }}?')">
                          {% csrf_token %}
                          <button type="submit" class="px-3 py-1.5 bg-green-500 text-white text-xs font-medium rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" title="Setujui Akun">
                            <i class="fas fa-user-check"></i> <span class="hidden sm:inline">Setujui</span>
                          </button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
                      <div class="flex flex-col items-center justify-center">
                        <i class="fas fa-users text-gray-400 text-3xl mb-3"></i>
                        <span class="font-semibold">Belum Ada Pengguna</span>
                        <p class="mt-1">Tidak ada pengguna yang terdaftar.</p>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
        </div>
        {% endif %}
    </div>
  </div>
</div>
{% endblock %}