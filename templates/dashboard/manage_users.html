{% extends "_base_dashboard.html" %}
{% load static %}

{% block title %}Manajemen Pengguna - Gagasan{% endblock %}

{% block dashboard_content %}
<div class="p-8">
  <div class="flex items-center gap-4 mb-6">
    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
      <i class="fas fa-users-cog text-purple-600 text-xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Manajemen Pengguna</h1>
      <p class="text-sm text-gray-600">Setujui pendaftaran baru atau aktifkan/nonaktifkan akun pengguna yang sudah ada.</p>
    </div>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
      <p class="text-sm font-medium text-gray-500">Total Pengguna</p>
      <p class="text-3xl font-bold text-gray-900 mt-1">{{ total_users_count }}</p>
    </div>
    <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
      <p class="text-sm font-medium text-gray-500">Pengguna Aktif</p>
      <p class="text-3xl font-bold text-green-600 mt-1">{{ active_users_count }}</p>
    </div>
    <div class="bg-white p-5 rounded-lg shadow-sm border {% if pending_approval_count > 0 %}border-yellow-300 bg-yellow-50{% else %}border-gray-200{% endif %}">
      <p class="text-sm font-medium {% if pending_approval_count > 0 %}text-yellow-800{% else %}text-gray-500{% endif %}">Menunggu Persetujuan</p>
      <p class="text-3xl font-bold {% if pending_approval_count > 0 %}text-yellow-700{% else %}text-gray-900{% endif %} mt-1">{{ pending_approval_count }}</p>
    </div>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
      <p class="text-sm font-medium text-gray-500">Mahasiswa</p>
      <p class="text-2xl font-bold text-gray-900 mt-1">{{ mahasiswa_count }}</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
      <p class="text-sm font-medium text-gray-500">Dosen</p>
      <p class="text-2xl font-bold text-gray-900 mt-1">{{ dosen_count }}</p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
      <p class="text-sm font-medium text-gray-500">Mitra Industri</p>
      <p class="text-2xl font-bold text-gray-900 mt-1">{{ mitra_count }}</p>
    </div>
  </div>


  {% if messages %}
    <div class="mb-6 space-y-2">
        {% for message in messages %}
        <div class="p-4 rounded-md text-sm
            {% if message.tags == 'success' %} bg-green-50 border border-green-200 text-green-800
            {% elif message.tags == 'warning' %} bg-yellow-50 border border-yellow-200 text-yellow-800
            {% elif message.tags == 'error' %} bg-red-50 border border-red-200 text-red-800
            {% else %} bg-blue-50 border border-blue-200 text-blue-800 {% endif %} flex items-start gap-2">
             {% if message.tags == 'success' %}<i class="fas fa-check-circle mt-0.5"></i>
             {% elif message.tags == 'warning' %}<i class="fas fa-exclamation-triangle mt-0.5"></i>
             {% elif message.tags == 'error' %}<i class="fas fa-times-circle mt-0.5"></i>
             {% else %}<i class="fas fa-info-circle mt-0.5"></i>{% endif %}
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
  {% endif %}

  <div class="mb-6 border-b border-gray-200">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
      <a href="?tab=all" class="{% if current_tab == 'all' %}border-purple-500 text-purple-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        Semua Pengguna
        <span class="bg-gray-100 text-gray-600 ml-2 py-0.5 px-2.5 rounded-full text-xs font-medium">{{ all_users_list.count }}</span>
      </a>
      <a href="?tab=pending" class="{% if current_tab == 'pending' %}border-purple-500 text-purple-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
        Permintaan Akun
        <span class="{% if pending_approval_count > 0 %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-600{% endif %} ml-2 py-0.5 px-2.5 rounded-full text-xs font-medium">{{ pending_approval_count }}</span>
      </a>
    </nav>
  </div>
  <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
    <form method="GET" action="" class="flex flex-col md:flex-row gap-4">
      <input type="hidden" name="tab" value="{{ current_tab }}">

      <div class="flex-1">
        <input type="text" name="q" value="{{ current_q }}" placeholder="Cari username atau email..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
      </div>

      <div class="w-full md:w-48">
        <select name="role" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
          <option value="">Semua Peran</option>
          <option value="mahasiswa" {% if current_role == 'mahasiswa' %}selected{% endif %}>Mahasiswa</option>
          <option value="dosen" {% if current_role == 'dosen' %}selected{% endif %}>Dosen</option>
          <option value="mitra" {% if current_role == 'mitra' %}selected{% endif %}>Mitra Industri</option>
        </select>
      </div>

      <div class="w-full md:w-48">
        <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
          <option value="">Semua Status</option>
          <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Menunggu Persetujuan</option>
          <option value="approved" {% if current_status == 'approved' %}selected{% endif %}>Disetujui</option>
          <option value="aktif" {% if current_status == 'aktif' %}selected{% endif %}>Status Aktif</option>
          <option value="nonaktif" {% if current_status == 'nonaktif' %}selected{% endif %}>Status Nonaktif</option>
        </select>
      </div>

      <div class="flex gap-2">
        <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
          <i class="fas fa-filter mr-1"></i> Filter
        </button>
        <a href="?tab={{ current_tab }}" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-center">
          Reset
        </a>
      </div>
    </form>
  </div>
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b flex justify-between items-center">
      <h2 class="text-lg font-semibold">
        {% if current_tab == 'pending' %}
          Daftar Permintaan Akun ({{ users_list.count }})
        {% else %}
          Daftar Semua Pengguna ({{ users_list.count }})
        {% endif %}
      </h2>
      </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>
            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Disetujui</th>
            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Daftar</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          
          {% for user_obj in users_list %}
          <tr class="{% if not user_obj.is_approved %} bg-yellow-50 {% elif user_obj.status == 'nonaktif' %} bg-red-50 {% endif %}"> {# Highlight baris #}
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user_obj.username }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.email }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.get_peran_display }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
              {% if user_obj.is_approved %}
                <i class="fas fa-check-circle text-green-500" title="Ya"></i>
              {% else %}
                <i class="fas fa-clock text-yellow-500" title="Menunggu Persetujuan"></i>
              {% endif %}
            </td>
             <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
              {% if user_obj.status == 'aktif' %}
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Aktif</span>
              {% elif user_obj.status == 'nonaktif' %}
                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Nonaktif</span>
              {% else %}
                 <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">{{ user_obj.status|capfirst }}</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user_obj.date_joined|date:"d M Y H:i" }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-1">
              {# Tombol Setujui hanya muncul jika belum diapprove #}
              {% if not user_obj.is_approved %}
                <form action="{% url 'approve_user' user_obj.id %}" method="POST" class="inline-block" onsubmit="return confirm('Anda yakin ingin menyetujui dan mengaktifkan akun {{ user_obj.username }}?')">
                  {% csrf_token %}
                  <button type="submit" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" title="Setujui Akun">
                    <i class="fas fa-user-check"></i> <span class="sr-only">Setujui</span>
                  </button>
                </form>
              {% endif %}

              {# Tombol Aktifkan/Nonaktifkan #}
              <form action="{% url 'toggle_active_user' user_obj.id %}" method="POST" class="inline-block" onsubmit="return confirm('Anda yakin ingin mengubah status akun {{ user_obj.username }}?')">
                 {% csrf_token %}
                 <input type="hidden" name="current_tab" value="{{ current_tab }}">
                 
                 {% if user_obj.status == 'aktif' %}
                   <button type="submit" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" title="Nonaktifkan Akun">
                     <i class="fas fa-user-times"></i> <span class="sr-only">Nonaktifkan</span>
                   </button>
                 {% elif user_obj.status == 'nonaktif' %}
                     {# Tombol Aktifkan disable jika belum diapprove #}
                     <button type="submit" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 {% if not user_obj.is_approved %} opacity-50 cursor-not-allowed {% endif %}"
                       {% if not user_obj.is_approved %}disabled title="Setujui dulu akun ini sebelum mengaktifkan"{% else %} title="Aktifkan Akun" {% endif %}>
                       <i class="fas fa-user-plus"></i> <span class="sr-only">Aktifkan</span>
                     </button>
                 {% endif %}
                 {# Pertimbangkan Tombol Hapus User #}
                 {# <button type="button" class="px-2 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500" title="Hapus Akun (Belum aktif)"><i class="fas fa-trash"></i></button> #}
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-12 text-center text-sm text-gray-500">
              <i class="fas fa-users text-gray-400 text-3xl mb-3"></i><br>
              {% if current_tab == 'pending' %}
                Tidak ada permintaan akun baru.
              {% else %}
                Tidak ada pengguna (Mahasiswa, Dosen, Mitra) yang terdaftar.
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
     </div>
</div>
{% endblock %}

{% block extra_scripts %}
{# Tidak perlu JS tambahan #}
{% endblock %}