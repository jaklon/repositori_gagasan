{% extends "_base_dashboard.html" %}
{% load static %}
{% load repository_extras %} {# TAMBAHAN: Muat custom template tags #}

{% block title %}Tahap 2: Penugasan Kurator - Gagasan{% endblock %}

{% block dashboard_content %}
<div class="p-8">
  <div class="flex items-center gap-4 mb-6">
    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
      <i class="fas fa-user-check text-purple-600 text-xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Tahap 2: Penugasan Kurator</h1>
      <p class="text-sm text-gray-600">Tugaskan kurator dosen dan industri untuk setiap produk (Batas: 3 hari kerja).</p>
    </div>
  </div>

  <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6 text-xs text-center">
      <div class="text-green-600 font-semibold">
          <div class="w-6 h-6 mx-auto rounded-full bg-green-100 flex items-center justify-center mb-1"><i class="fas fa-check"></i></div>
          Seleksi Proyek
      </div>
      <div class="flex-1 h-px bg-gray-200 mx-2 relative"><div class="absolute left-0 top-0 h-px bg-green-500 w-full"></div></div>
      <div class="text-purple-600 font-semibold">
          <div class="w-6 h-6 mx-auto rounded-full bg-purple-100 ring-2 ring-purple-300 flex items-center justify-center mb-1"><i class="fas fa-user-check"></i></div>
          Penugasan Kurator
      </div>
      <div class="flex-1 h-px bg-gray-200 mx-2"></div>
      <div class="text-gray-400">
          <div class="w-6 h-6 mx-auto rounded-full bg-gray-100 flex items-center justify-center mb-1"><i class="fas fa-tasks"></i></div>
          Monitoring Penilaian
      </div>
      <div class="flex-1 h-px bg-gray-200 mx-2"></div>
      <div class="text-gray-400">
          <div class="w-6 h-6 mx-auto rounded-full bg-gray-100 flex items-center justify-center mb-1"><i class="fas fa-gavel"></i></div>
          Review & Keputusan
      </div>
       <div class="flex-1 h-px bg-gray-200 mx-2"></div>
      <div class="text-gray-400">
          <div class="w-6 h-6 mx-auto rounded-full bg-gray-100 flex items-center justify-center mb-1"><i class="fas fa-upload"></i></div>
          Publikasi Katalog
      </div>
  </div>


  <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 flex items-start gap-3 mb-6 shadow-sm">
    <i class="fas fa-exclamation-triangle text-orange-500 mt-1"></i>
    <div>
      <h3 class="font-semibold text-orange-800">Peringatan Deadline</h3>
      <p class="text-sm text-orange-700">Terdapat produk yang mendekati atau melewati batas waktu penugasan kurator. Harap segera menugaskan kurator untuk menghindari keterlambatan proses.</p>
    </div>
  </div>

  <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-start gap-3 mb-8 shadow-sm">
    <i class="fas fa-arrow-right text-green-600 mt-1"></i>
    <div>
      <h3 class="font-semibold text-green-800">Langkah Selanjutnya</h3>
      <p class="text-sm text-green-700">Setelah menugaskan kurator, pantau progres di <strong>Tahap 3: Monitoring Penilaian</strong>.</p>
    </div>
  </div>

   <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
     <div class="relative">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        <input type="text" placeholder="Cari produk..." class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"/>
      </div>
  </div>

  <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b">
      <h2 class="text-lg font-semibold">Produk Menunggu Penugasan ({{ projects_selected.count }})</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul Produk</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mahasiswa</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Seleksi</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sisa Waktu</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for project in projects_selected %}
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ project.title }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ project.id_pemilik.username }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
               {% for cat in project.kategori.all %}{{ cat.nama }}{% if not forloop.last %}, {% endif %}{% empty %}N/A{% endfor %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ project.updated_at|date:"d M Y" }} </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                {% with deadline_dt=project.updated_at|add_days:3 %}
                   {% now "Y-m-d H:i:s" as current_time_str %}
                   {% parse_datetime current_time_str as current_dt %}
                   
                   {% if deadline_dt and current_dt %}
                       {% timeuntil_days deadline_dt current_dt as days_left %}
                       
                       {% if days_left < 0 %}
                           <span class="text-red-600 font-semibold">
                               Terlambat {{ days_left|cut:"-"|default:"0" }} hari
                           </span>
                       {% elif days_left == 0 %}
                            <span class="text-orange-600 font-semibold">
                                Hari Ini
                            </span>
                       {% else %}
                             <span class="text-gray-700">
                                {{ days_left }} hari lagi
                             </span>
                       {% endif %}
                   {% else %}
                        <span class="text-gray-400">N/A</span>
                   {% endif %}
                {% endwith %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button
                type="button"
                onclick="openAssignModal('{{ project.id }}', '{{ project.title|escapejs }}', '{{ project.id_pemilik.username|escapejs }}', '{{ project.kategori.first.nama|default:"N/A"|escapejs }}')"
                class="px-3 py-1.5 bg-purple-600 text-white text-xs font-medium rounded-md hover:bg-purple-700 transition-colors"
              >
                <i class="fas fa-user-plus mr-1"></i> Tugaskan Kurator
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
              Tidak ada produk yang menunggu penugasan kurator.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<div id="assignModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
  <div class="bg-white rounded-xl max-w-lg w-full shadow-xl transform transition-all" onclick="event.stopPropagation();">
      <div class="p-5 border-b flex justify-between items-center">
          <h2 class="text-xl font-semibold">Tugaskan Kurator</h2>
          <button onclick="closeAssignModal()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
      </div>
      <form id="assignForm" method="POST" action=""> {% csrf_token %}
           <input type="hidden" name="project_id" id="modalProjectId"> <div class="p-6 space-y-4">
              <p class="text-sm text-gray-600">Pilih kurator dosen dan mitra industri untuk produk "<strong id="modalProjectTitle">Nama Proyek</strong>"</p>
              <div class="bg-gray-50 p-4 rounded-lg flex justify-between text-sm border">
                  <div>
                      <span class="text-gray-500">Mahasiswa:</span>
                      <strong class="block text-gray-800" id="modalStudentName">Nama Mahasiswa</strong>
                  </div>
                   <div>
                      <span class="text-gray-500">Kategori:</span>
                      <strong class="block text-gray-800" id="modalCategoryName">Nama Kategori</strong>
                  </div>
              </div>

              <div>
                  <label for="id_kurator_dosen" class="block text-sm font-medium text-gray-700 mb-1">Kurator Dosen <span class="text-red-500">*</span></label>
                  <select name="kurator_dosen" id="id_kurator_dosen" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                      <option value="" selected>Pilih Dosen</option>
                      {% for dosen in dosen_list %}
                          <option value="{{ dosen.id }}">
                              {{ dosen.username }} 
                              {% if dosen.jurusan %} - {{ dosen.jurusan }}{% endif %}
                          </option>
                      {% endfor %}
                  </select>
                  {% if assign_form.kurator_dosen.errors %}
                      <p class="text-xs text-red-600 mt-1">{{ assign_form.kurator_dosen.errors|striptags }}</p>
                  {% endif %}
              </div>
              <div>
                  <label for="id_kurator_mitra" class="block text-sm font-medium text-gray-700 mb-1">Kurator Mitra Industri <span class="text-red-500">*</span></label>
                  <select name="kurator_mitra" id="id_kurator_mitra" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                      <option value="" selected>Pilih Mitra</option>
                      {% for mitra in mitra_list %}
                          <option value="{{ mitra.id }}">
                              {{ mitra.username }}
                              {% if mitra.organisasi %} - {{ mitra.organisasi }}{% endif %}
                          </option>
                      {% endfor %}
                  </select>
                   {% if assign_form.kurator_mitra.errors %}
                      <p class="text-xs text-red-600 mt-1">{{ assign_form.kurator_mitra.errors|striptags }}</p>
                  {% endif %}
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-xs text-blue-700 flex items-start gap-2">
                   <i class="fas fa-info-circle mt-0.5"></i>
                   <span><strong>Catatan:</strong> Setelah kurator ditugaskan, mereka memiliki waktu 10 hari kalender untuk menyelesaikan penilaian produk ini.</span>
               </div>

           </div>
           <div class="p-4 border-t bg-gray-50 flex gap-3 justify-end rounded-b-xl">
               <button type="button" onclick="closeAssignModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium">
                   Batal
               </button>
                <button type="submit" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium flex items-center gap-1.5">
                   <i class="fas fa-user-check"></i> Tugaskan Kurator
               </button>
           </div>
       </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const modalElement = document.getElementById('assignModal');
    const assignForm = document.getElementById('assignForm');
    const modalProjectIdInput = document.getElementById('modalProjectId');
    const modalProjectTitle = document.getElementById('modalProjectTitle');
    const modalStudentName = document.getElementById('modalStudentName');
    const modalCategoryName = document.getElementById('modalCategoryName');

    function openAssignModal(projectId, projectTitle, studentName, categoryName) {
        // Isi data ke modal
        modalProjectIdInput.value = projectId;
        modalProjectTitle.textContent = projectTitle;
        modalStudentName.textContent = studentName;
        modalCategoryName.textContent = categoryName;

        // Set action URL form (menuju view yang akan menangani POST)
        assignForm.action = `/assign-curator/${projectId}/`; // Sesuaikan URL ini

        // Reset pilihan dropdown (jika perlu)
        assignForm.reset();

        // Tampilkan modal
        modalElement.classList.remove('hidden');
    }

    function closeAssignModal() {
        modalElement.classList.add('hidden');
    }

    // Tutup modal jika klik di luar area modal
    modalElement.addEventListener('click', function(event) {
        if (event.target === modalElement) {
            closeAssignModal();
        }
    });
</script>
{% endblock %}